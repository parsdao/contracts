name: Audit

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - '.github/workflows/audit.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
  workflow_dispatch:

env:
  FOUNDRY_PROFILE: ci

jobs:
  contract-inventory:
    name: Contract Inventory
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Count contracts
        run: |
          echo "## Contract Inventory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(find src -name "*.sol" | wc -l)
          echo "**Total Solidity files:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### By Directory" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find src -name "*.sol" | xargs dirname | sort | uniq -c | sort -rn >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build
        run: forge build

      - name: Run tests
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          forge test -vv --summary 2>&1 | tee test-results.txt || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 test-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.txt
          if-no-files-found: ignore

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Coverage
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          forge coverage --ir-minimum --report summary 2>&1 | tee coverage-summary.txt || \
          forge coverage --report summary 2>&1 | tee coverage-summary.txt || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat coverage-summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage-summary.txt
          if-no-files-found: ignore

  gas-analysis:
    name: Gas Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Gas Report
        run: |
          echo "## Gas Report" >> $GITHUB_STEP_SUMMARY
          forge test --gas-report 2>&1 | tee gas-report.txt || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 gas-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt
          if-no-files-found: ignore

  audit-summary:
    name: Audit Summary
    needs: [contract-inventory, build-test, coverage, gas-analysis]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Inventory | ${{ needs.contract-inventory.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gas Analysis | ${{ needs.gas-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
