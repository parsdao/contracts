name: Security

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - '.github/workflows/security.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

env:
  FOUNDRY_PROFILE: ci

jobs:
  slither:
    name: Slither Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build contracts
        run: forge build --build-info

      - name: Run Slither
        uses: crytic/slither-action@v0.4.0
        id: slither
        with:
          sarif: results.sarif
          fail-on: none
          slither-args: --filter-paths "lib/"
        continue-on-error: true

      - name: Create empty SARIF if missing
        if: always()
        run: |
          if [ ! -f results.sarif ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Slither","informationUri":"https://github.com/crytic/slither","version":"0.0.0","rules":[]}},"results":[]}]}' > results.sarif
          fi

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  aderyn:
    name: Aderyn Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install Aderyn
        run: cargo install aderyn

      - name: Run Aderyn
        run: aderyn . --skip-build || true
        continue-on-error: true

      - name: Upload Aderyn Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aderyn-report
          path: report.md
          if-no-files-found: ignore

  fuzz:
    name: Forge Fuzz Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Fuzz Tests
        run: forge test --fuzz-runs 1000 || true
        continue-on-error: true

  security-summary:
    name: Security Summary
    needs: [slither, aderyn, fuzz]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Analysis | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Slither | ${{ needs.slither.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Aderyn | ${{ needs.aderyn.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fuzz Testing | ${{ needs.fuzz.result }} |" >> $GITHUB_STEP_SUMMARY
